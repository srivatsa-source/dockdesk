name: Semantic Audit

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  audit:
    name: Semantic Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Perception Node (Identify Changed Files)
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.py
            **/*.js
            **/*.md

      - name: Setup Python
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          pip install google-genai colorama

      - name: Reasoning Layer (Run Integrity Agent)
        if: steps.changed-files.outputs.any_changed == 'true'
        id: agent
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python integrity_agent.py --files ${{ steps.changed-files.outputs.all_changed_files }} --doc README.md > audit_report.md
          cat audit_report.md

      - name: Gatekeeper Action (Post Audit Report)
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: semantic-audit
          path: audit_report.md
